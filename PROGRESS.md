# POS Implementation Progress

Tracking execution of the implementation plan (split into three files):
- `docs/plans/2026-02-06-backend-plan.md` — Go API (M1-6 done), Docker (M7 done), Deploy (M10)
- `docs/plans/2026-02-06-android-pos-plan.md` — Android POS (M8 done)
- `docs/plans/2026-02-06-sveltekit-admin-plan.md` — SvelteKit Admin (M9)
- `docs/plans/2026-02-08-cicd-design.md` — CI/CD design doc
- `docs/plans/2026-02-08-cicd-plan.md` — CI/CD implementation plan

## Active Branch

`feature/milestone-9-sveltekit-admin` — Worktree at `.worktrees/milestone-9-sveltekit-admin`. 5 commits ahead of main.

## Milestones

### Milestone 1: Project Scaffolding & Database — DONE

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 1.1: Initialize Go API project | Done | `8911b67` | Go module, main.go, /health, config loader |
| 1.2: Docker Compose for local dev | Done | `74df987` | PostgreSQL 16-alpine with healthcheck |
| 1.3: Database migrations — all 14 tables | Done | `4b155de` | 10 enums, 14 tables, indexes, triggers |
| 1.4: Set up sqlc | Done | `d19e435` | sqlc.yaml, outlet queries, generated code |

### Milestone 2: Go API — Auth & Middleware — DONE

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 2.1: JWT token generation & validation | Done | `20c3ff6` | GenerateToken, ValidateToken, 3 tests |
| 2.2: Auth middleware & outlet scoping | Done | `9234879` | Authenticate, RequireOutlet, RequireRole, 7 tests |
| 2.3: Login & PIN login handlers | Done | `71278e8` | login, pin-login, refresh. Chi router. 13 tests |
| 2.4: User CRUD handlers | Done | `e005fdf` | list, create, update, soft-delete. 24 tests |

### Milestone 3: Go API — Menu Management — DONE

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 3.1: Category CRUD | Done | `929648f` | list, create, update, soft-delete. 23 tests |
| 3.2: Product CRUD | Done | `c70283a` | 5 endpoints, decimal price handling, FK validation. 33 tests |
| 3.3: Variant Groups & Variants CRUD | Done | `a6bc06d` | 8 endpoints, cascading ownership verification. 43 tests |
| 3.4: Modifier Groups & Modifiers CRUD | Done | `0e0714e` | 8 endpoints, min/max select constraints. 51 tests |
| 3.5: Combo Items CRUD | Done | `ad913c2` | 3 endpoints (list, create, hard delete). 25 tests |

### Milestone 4: Go API — Orders & Payments — DONE

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 4.1: Order Creation (Atomic) | Done | `b6c111b` | POST /orders, service layer, tx retry, price snapshots. 46 tests (18 handler + 28 service) |
| 4.2: Order Queries & Status Management | Done | `e3587b2` | GET list (filters, pagination), GET detail (nested items/modifiers/payments), PATCH status transitions, DELETE cancel. TOCTOU fix, completed_at on COMPLETED. 32 tests |
| 4.3: Order Item Modifications | Done | `d06f626` | POST add item, PUT update qty/notes, DELETE remove item, PATCH kitchen status. Tx-wrapped writes, order total recalc. 25 tests |
| 4.4: Multi-Payment | Done | `a248215`, `8a95339` | POST add payment, GET list payments. CASH/QRIS/TRANSFER, change calculation, overpayment prevention, auto-complete order on full payment. Catering lifecycle: BOOKED→DP_PAID→SETTLED. TOCTOU fix: SELECT FOR NO KEY UPDATE inside tx. Post-review fix: explicit COMPLETED order guard. 21 tests |

### Milestone 5: Go API — CRM, Reports, WebSocket — DONE

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 5.1: Customer CRUD + Stats | Done | `347fb81` | 7 endpoints: list (search), get, create, update, soft-delete, stats (total_spend/avg_ticket/top_items), order history. Unique phone constraint handling (409). Stats scoped by outlet_id. 24 tests |
| 5.2: Reports Endpoints | Done | `593b81e` | 5 endpoints: daily-sales, product-sales, payment-summary, hourly-sales, outlet-comparison. All with date range filtering (Asia/Jakarta timezone). Owner-only outlet-comparison. Strongly-typed sqlc params (end-of-day computed in Go). 12 tests |
| 5.3: WebSocket for Live Order Updates | Done | `c2026f6` | Hub with per-outlet rooms, Client with ReadPump/WritePump, ServeWS handler with JWT auth via query param. Events: order.created/updated, item.updated, order.paid. gorilla/websocket. Thread-safe broadcast with write lock. 8 tests |

### Milestone 6: Go API — Router Assembly & Integration Test — DONE

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 6.1: Wire Everything Together | Done | `92f4930` | router.go wiring all 11 handler groups into Chi router. Auth middleware on protected routes, RequireOutlet on outlet-scoped, RequireRole("OWNER") on reports. CORS for dev+prod. WebSocket route. main.go with pgxpool, graceful shutdown. Review fix: WriteTimeout 0 for WebSocket compatibility. |
| 6.2: Integration Tests | Done | `8c5adf6` | End-to-end test with real PostgreSQL via testcontainers-go. Full lifecycle: outlet→user→login→category→product→variants→modifiers→order→multi-payment (CASH+QRIS split)→verify auto-complete→customer stats. Price snapshot assertion (57000.00). Build tag `integration`. Review fixes: split payment verification, price assertion, documentation comments. |

### Milestone 7: Docker Production Setup — DONE

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 7.1: Production Docker Compose | Done | `722dc4d` | Dockerfile.api (golang:1.25-alpine multi-stage, non-root user), Dockerfile.admin (placeholder SvelteKit), docker-compose.yml (3 services, internal network isolation, proxy network for NPM, localhost-only ports). .dockerignore added. .env.example with production vars. Review fixes: Go version match, non-root user, 127.0.0.1 port binding, internal:true network, .dockerignore. |
| 7.2: Backup Script | Done | `637c7bb` | docker/backup.sh — pg_dump + gzip, 30-day retention. Review fixes: set -o pipefail (prevents silent pg_dump failures in pipe), -s file check (non-empty), cron log redirection. |

### Milestone 8: Android POS App — DONE

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 8.1: Scaffold Android Project | Done | `85e3ba7` | Gradle version catalogs, Kotlin 2.1.0, Compose BOM, KSP+Hilt, Retrofit+OkHttp NetworkModule, Kiwari brand theme (7 colors, light/dark, Material 3), project structure. Review fixes: emulator debug URL (10.0.2.2), config cache disabled, shrinkResources, strict Gson. Build fixes: compileSdk 34→35 (androidx.core 1.15 requires it), removed README.md from res/ dirs (resource merger rejects non-resource files). |
| 8.2: Login Screen | Done | `e29d6be` | AuthApi (3 endpoints), LoginScreen (email+PIN modes), LoginViewModel, AuthRepository with safeApiCall helper, TokenRepository (EncryptedSharedPreferences), AuthInterceptor (Bearer header), TokenAuthenticator (auto-refresh on 401 with dual OkHttpClient), NavGraph with auth-state routing. Review fixes: @Named("auth") DI qualifier, logout→login navigation, UserRole UNKNOWN fallback, innerPadding passthrough, clearError after snackbar, security-crypto stable 1.0.0, credential clearing. Build fixes: removed `/api/v1/` prefix from base URL (Go API has no version prefix), added `usesCleartextTraffic=true` for local HTTP dev. **Tested on real device — login works.** |
| 8.3: Menu Screen | Done | `9625dc8` | 15 new files, 3 modified. MenuApi (6 endpoints), MenuRepository, CartRepository (shared singleton), CategoryChips, ProductListItem (letter avatar, qty badge, tap+long-press), CartBottomBar, QuickEditPopup, MenuViewModel (parallel data loading, category/search filtering). Shared ApiHelper extracted (DRY), CurrencyFormatter utility. Spec review fixes: nullable preparationTime/maxSelect, placeholder NavGraph routes. Code quality fixes: trailing slashes, parallel loadVariantInfo, pre-computed filteredProducts, cached NumberFormat. |
| 8.4: Product Customization Bottom Sheet | Done | `417f70d` | 3 new files, 4 modified. CustomizationScreen (full-screen, radio variants, checkbox modifiers with min/max enforcement, qty selector, notes, price calc), CustomizationViewModel (parallel variant+modifier loading, real-time BigDecimal price), SelectedProductRepository (@Volatile bridge). Refactored CartItem.selectedVariant→selectedVariants (List) to support multi-variant-group products. Spec review fix: multi-variant bug (only first group stored). Code quality fixes: retry() after product cleared, filter empty variant/modifier groups, one-shot event pattern, qty cap 999, buildConstraintHint min==max. |
| 8.4b: Bold + Clean Theme Redesign | Done | `9a44467`, `5ef9dee`, `4583e31` | 3 commits, 8 files modified. New color palette (9 tokens, removed 10 old), removed dark theme entirely, added custom Shapes (8-16dp), tightened typography 11-20sp, replaced all hardcoded color imports with MaterialTheme.colorScheme tokens, category chips green→yellow selected state, avatar circle→rounded rect, elevation 8→4dp. Design spec: `docs/plans/2026-02-07-android-theme-redesign.md`. Implementation plan: `docs/plans/2026-02-07-android-theme-implementation.md`. |
| 8.5: Cart Screen | Done | `d771cb4` | 6 new files, 2 modified (1469 lines). CartScreen (full page, LazyColumn), CartViewModel (order metadata, customer search with 300ms debounce, BigDecimal discount calc), CartItemCard (edit/delete/qty controls, variant+modifier summary). CustomerApi (search+create), Customer model, CustomerRepository. Order type chips (Dine-in/Takeaway/Delivery/Catering), table number (dine-in only), customer search dropdown with add-new dialog, discount section (percentage/fixed/none), subtotal/discount/total summary, BAYAR button with catering validation. NavGraph wired + Payment placeholder. Build fix: Icons.Default.Remove→text "−" (no extended icons dep). Spec review fixes: added Edit button (notes dialog), numeric keyboard on table/discount/phone fields. Code quality fixes: removed 3 unused imports (BorderStroke, background, clickable), replaced fully qualified DropdownMenu/BigDecimal with imports, added OutlinedButton removal. |
| 8.6: Payment Screen | Done | `0dbf3ef` | 6 new files, 3 modified. OrderApi (createOrder+addPayment), OrderMetadataRepository (singleton bridge cart→payment state), PaymentViewModel (multi-payment entries, BigDecimal totals, two-step API: create order→add payments), PaymentScreen (order summary, payment cards with CASH/QRIS/TRANSFER chips, cash change calc, running paid/remaining bar, success screen). Spec review fixes: BigDecimal `==` → `compareTo()` for canSubmit (scale mismatch bug), client-side overpayment validation, added catering/delivery fields to CreateOrderRequest. Code quality fixes: removed dead capping code, extracted `coerceAtLeast` to shared util, `@Volatile` on OrderMetadataRepository, BackHandler blocks back during submission. |
| 8.7: Catering Booking Screen | Done | `6fde278` | 2 new files, 4 modified. CateringViewModel (50% DP calc via BigDecimal, RFC3339 date formatting, two-step create order→add DP payment, payment retry on orphaned order), CateringScreen (customer display, Material3 DatePicker future-only, delivery address, notes, DP payment with method chips, success screen). OrderMetadata extended with cateringDate/cateringDpAmount/deliveryAddress. CartScreen routes CATERING→CateringScreen (button text "LANJUT BOOKING"). Spec review fix: added notes field to CateringScreen. Code quality fixes: extracted parseBigDecimal/filterDecimalInput to shared BigDecimalExtensions.kt (DRY), createdOrderId for payment retry, disabled date picker during submission. |
| 8.8: Thermal Printer Integration | Done | `3f704f0` | 7 new files, 5 modified (1356 lines). EscPosCommands (byte constants, two-column layout, separator), ReceiptFormatter (formatReceipt + formatKitchenTicket with ReceiptData), BluetoothPrinterManager (@Singleton, SPP connect, Mutex thread safety, Dispatchers.IO), PrinterService (fire-and-forget orchestrator, auto-print check), PrinterPreferencesRepository (DataStore: MAC, paper width 58/80mm, auto-print, outlet name), PrinterSettingsScreen + ViewModel (paired devices list, test print, paper width chips, auto-print toggle, connection status). Integrated into PaymentViewModel + CateringViewModel (triggerAutoprint after success). Settings gear in MenuScreen. Spec review fix: CateringViewModel stale orderNumber → pass explicitly. Code quality fixes: debounced outlet name DataStore writes, isConnected() via StateFlow, maxSdkVersion=30 on legacy BT permissions, merge() extracted as shared utility, catering retry stores orderNumber in state, removed unused import. |

### CI/CD Setup — DONE

**Plan:** `docs/plans/2026-02-08-cicd-plan.md`
**Design:** `docs/plans/2026-02-08-cicd-design.md`
**Secrets:** `docs/plans/2026-02-08-cicd-secrets.md` (local only, gitignored)

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 1: Update CORS origins | Done | `5672a0e` | Added staging + production admin domains, kept legacy pos.nasibakarkiwari.com |
| 2: API CI workflow | Done | `8fc84be` | .github/workflows/api-ci.yml — test→build→push→deploy staging |
| 3: Admin CI workflow | Done | `dd96446` | .github/workflows/admin-ci.yml — build→push→deploy staging |
| 4: Production promotion workflow | Done | `a944826` | .github/workflows/promote.yml — re-tag staging→latest, deploy prod |
| 5: VPS deploy compose files | Done | `5608222` | deploy/ directory: postgres, staging, production compose + env examples |
| 6: Update .gitignore | Done | `ed3e6d1` | deploy/*/.env, admin.env, *-secrets.md all ignored |
| Review fixes | Done | `a3200c4` | Secret exposure (envs param), PORT conflict (split .env/admin.env), concurrency groups, self-reference path filters, docker image prune |
| VPS: PostgreSQL + databases | Done | — | Shared postgres container, pos_staging + pos_production DBs, separate users, migrations run |
| VPS: Deploy directories | Done | — | ~/docker/pos-staging/ and ~/docker/pos-production/ with .env files |
| GitHub secrets | Done | — | VPS_HOST, VPS_USER, VPS_SSH_KEY, GHCR_TOKEN set |
| GitHub environments | Done | — | staging + production environments created |
| Cloudflare DNS | Done | — | A records for stg-api, stg-admin, api, admin |
| NPM proxy hosts (API) | Done | — | stg-api + api proxy hosts. WebSocket via Advanced custom config (NPM bug: WS toggle causes duplicate proxy_http_version) |
| NPM proxy hosts (Admin) | Deferred | — | Admin still in early development (M9), will add when ready |
| End-to-end pipeline test | Done | `4bc08b3` | Staging: push to main triggered API CI → image built → deployed. Production: tag v1.0.0 → promote.yml re-tagged staging→latest → deployed. Both verified via /health. NPM config generation bug fixed (WS toggle off + custom location block). |

**Architecture:** GitHub Actions → build in CI → push to ghcr.io → SSH to VPS → docker compose pull + up. Push to main → staging, tag v* → production. Registry: `ghcr.io/iqbalmuhyiddin/kiwari-api`, `ghcr.io/iqbalmuhyiddin/kiwari-admin`. First release: v1.0.0.

### Milestone 10: Deploy & Seed — DONE

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 10.1: Deploy to VPS | ✅ Done | — | Covered by CI/CD (GitHub Actions → ghcr.io → SSH deploy) |
| 10.1b: Backup script (production) | ✅ Done | `19a5484` | `deploy/postgres/backup.sh` — backs up both pos_staging + pos_production from shared postgres container. Crontab: `0 2 * * * /home/iqbal/docker/postgres/backup.sh >> /home/iqbal/backups/pos/backup.log 2>&1` |
| 10.2: Seed script | ✅ Done | `bbc02c3` | `api/cmd/seed/main.go` — creates outlet + owner user. Idempotent, tx-wrapped, bcrypt, CLI flags with env fallback. `make db-seed` target updated. Review fixes: transaction wrapper, pgx.ErrNoRows error checking, default password warning. |

**VPS TODO (manual):** Add crontab entry on VPS for backup script, run seed script on production DB.

### Milestone 9: SvelteKit Admin — IN PROGRESS

> **Plan:** `docs/plans/2026-02-06-sveltekit-admin-plan.md`

| Task | Status | Commit | Notes |
|------|--------|--------|-------|
| 9.1: Scaffold SvelteKit Project | Done | `6e73b06` | SvelteKit 2 + Svelte 5 + Tailwind CSS 4 + TypeScript + pnpm. adapter-node for Docker. DM Sans font (Google Fonts). Bold+Clean design tokens: 10 colors, typography (5 presets), shapes (4 radii), spacing (8dp grid) as CSS vars in @theme block. Component utility classes (.btn-primary, .btn-secondary, .input-field). API client stub with typed fetch wrapper (GET/POST/PUT/PATCH/DELETE). Auth store stub (Svelte 5 runes). Sidebar (240px fixed, 6 nav links, active state). Code quality fixes: API client reads token from auth store (not localStorage), Content-Type only when body, delete returns Promise<void>, removed unused adapter-auto, robots.txt disallow all. |
| 9.2: Auth Pages (Login + Protected Layout) | Done | `404d2fa` | Server-side auth: JWT in 3 httpOnly cookies (access_token 1d, refresh_token 7d, user_info 7d). Auth hook (hooks.server.ts) decodes JWT payload (base64 only, no signature verify), handles proactive refresh (30s buffer), sets locals.user. Login page: Bold+Clean design (green bg, white card, yellow K logo). Form action calls Go API, sets cookies, redirects. Protected (app) layout redirects to /login if no session. Sidebar: user info footer (initials avatar, name, role), role-based nav (Reports/Settings OWNER/ADMIN only). Logout clears all cookies. Server-side API helper ($lib/server/api.ts) with discriminated union results. Spec review caught critical JWT field mismatch: Go API uses `user_id` not `sub`, JWT lacks `email`/`full_name` → fixed with user_info cookie. Code quality fixes: open redirect vulnerability (validate redirect starts with /), shared types extracted ($lib/types/api.ts), shared cookie utils ($lib/server/cookies.ts), dead ternary in client.ts removed. |
| 9.3: Dashboard Page | Done | `6e93ff8` | 4 KPI cards: revenue (Rp format), order count, avg ticket, payment method breakdown. Pure CSS hourly sales bar chart (hours 6-22, green bars, compact labels "jt"/"rb", zero dependencies). Live active orders panel with 10s polling via SvelteKit server endpoint (/api/orders/active). All data loaded server-side via parallel Promise.all (daily-sales, hourly-sales, payment-summary, active orders). Polling keeps JWT server-side (proxy pattern). Indonesian labels throughout. Responsive grid (4→2→1 col). Spec review caught 2 bugs: (1) Go API wraps order list in {orders:[], limit, offset} not bare array → unwrapped, (2) Go API only supports single status filter (`Query().Get()`) → two parallel calls (NEW + PREPARING) merged. Code quality fixes: extracted formatRupiah to $lib/utils/format.ts (DRY), non-null assertion comments, Cache-Control: no-store on polling endpoint. StatsCard reusable component. |
| 9.4: Menu Management Pages | Done | `3d3a8dc` | Category CRUD tabs (inline "Kelola Kategori" panel), product grid with search+category filter, product detail/edit page with basic info form (name, price, category, station, prep time, image URL, description, is_combo, is_active toggle). VariantGroupEditor (collapsible groups, inline variant CRUD, price adjustment display). ModifierGroupEditor (collapsible groups, min/max rules, inline modifier CRUD). Combo items (add/remove with product dropdown). 16 form actions in product detail page. All SvelteKit form actions with use:enhance. Indonesian labels. Spec review caught: TS types didn't match Go API (nullable fields, missing/extra fields, combo_product_id→combo_id, product_name not in API), hardcoded hex colors, dead deleteProduct action. Code quality caught: missing is_active toggle (users couldn't reactivate), preparation_time:0 treated as falsy via `0\|\|undefined`. |
| 9.5: Orders Page | Done | `f6f3ece` | Order list with filters (status, type, date range, search by order number), tab bar (Semua Pesanan / Katering), offset-based pagination. Catering card layout with DP amount, remaining balance, upcoming date highlight, delivery address. Slide-in order detail panel (480px, right side): items with product names, variant/modifier info, payment breakdown (CASH/QRIS/TRANSFER badges), order summary, status action buttons (valid transitions only). OrderTimeline (4-step horizontal: Baru→Diproses→Siap→Selesai, green checks, glow effect, cancelled banner). Proxy endpoint /api/orders/[id] enriches items with product_name + customer_name/phone (parallel fetch from products+customer endpoints). Shared labels.ts extracted (DRY). Spec review caught critical type mismatch: Go API returns product_id/variant_id/modifier_id only (no names) → fixed with proxy enrichment. Code quality caught: customer shows raw UUID → enriched via proxy, misleading count on pagination → "20+" when hasMore, duplicated label functions → extracted to $lib/utils/labels.ts. |
| 9.6: Customer CRM Page | Pending | — | |
| 9.7: Reports Page | Pending | — | |
| 9.8: Settings & User Management | Pending | — | |

**Known gaps:** No outlet selector for Owner role on dashboard (API endpoint needed). No dark theme (by design). Nav icons are `##` placeholders. Go API order items don't return product_name/variant_name/modifier_name — SvelteKit proxy enriches product_name and customer info, but variant/modifier names still show generic labels. Catering card customer_id not resolved to name (would need N+1 fetches on list).

## Test Count

401 unit tests passing (3 auth + 303 handler + 28 service + 7 middleware + 8 ws + 52 subtests) + 1 integration test (build tag: `integration`)

## Resume Prompt

After `/clear`, use:
```
Read PROGRESS.md. M1-M8 done, CI/CD done, M10 done. M9 (SvelteKit Admin) IN PROGRESS — tasks 9.1-9.5 done (scaffold, auth, dashboard, menu management, orders), 9.6-9.8 pending. Worktree at .worktrees/milestone-9-sveltekit-admin, branch feature/milestone-9-sveltekit-admin (5 commits ahead). Shared utils: $lib/utils/format.ts (formatRupiah), $lib/utils/labels.ts (getStatusLabel, getOrderTypeLabel, etc). Use continue-execute with admin arg.
```

## Session Log

- **2026-02-08**: Session 20 — Completed 9.4 (Menu Management) and 9.5 (Orders Page). Used subagent-driven-development with two-stage review per task. (9.4) 8 files: menu list page (category chips, product grid, search), product detail page (16 form actions for product+variant+modifier+combo CRUD), 3 reusable components (ProductForm, VariantGroupEditor, ModifierGroupEditor). Spec review caught 7 issues: TS types didn't match Go API nullable fields, `combo_product_id`→`combo_id`, `product_name` not in combo API response (showed raw UUIDs), hardcoded hex colors, dead code. Code quality caught: missing `is_active` toggle (can't reactivate products), `preparation_time:0` falsy bug (`0||undefined`). All fixed. (9.5) 7 files: orders page (filter bar, tab bar, table, catering cards, pagination), OrderDetail slide-in panel, OrderTimeline component, proxy endpoint. Spec review caught critical type mismatch: Go API order items only return IDs not names → implemented proxy enrichment in `/api/orders/[id]` (parallel fetch products+customer, enrich before returning). Code quality caught: customer UUID display → enriched with name+phone via customer API, misleading count → "20+" when hasMore, duplicated label functions → extracted to `$lib/utils/labels.ts`. Known gap: variant/modifier names not resolved (would need N+1 variant group fetches per product — deferred). 2 commits, ~15 new files. Worktree 5 commits ahead of main.
- **2026-02-08**: Session 19 — **Milestone 9 started.** Completed 9.1 (Scaffold SvelteKit), 9.2 (Auth Pages), 9.3 (Dashboard). Used worktree `feature/milestone-9-sveltekit-admin`. Design reference: `docs/old-references/design-system/bold-clean-preview.html` (Bold+Clean with DM Sans, not Roboto). (9.1) SvelteKit 2 + Svelte 5 + Tailwind CSS 4 + adapter-node. Design tokens as CSS vars in @theme block. Sidebar 240px with active state. Code quality fixed: API client reads from auth store not localStorage, Content-Type conditional on body, robots.txt disallow all. (9.2) Server-side JWT auth: 3 httpOnly cookies (access_token, refresh_token, user_info). Auth hook decodes JWT (base64 only), proactive refresh 30s before expiry. Spec review caught critical bug: Go API JWT uses `user_id` not `sub`, lacks `email`/`full_name` → supplementary user_info cookie stores login response data. Code quality caught: open redirect vulnerability → validated redirect path, duplicated types → extracted to $lib/types/api.ts + $lib/server/cookies.ts. (9.3) Dashboard with 4 KPI cards (Rupiah format), pure CSS hourly bar chart (no Chart.js), live orders polling via SvelteKit proxy endpoint. Spec review caught 2 bugs: order list wrapped in `{orders:[]}` not bare array → unwrapped, Go API `Query().Get("status")` only returns first value → two parallel calls (NEW+PREPARING) merged. Code quality: extracted formatRupiah to $lib/utils/format.ts. Known gap: no outlet selector for Owner role (needs outlets list endpoint). 3 commits, ~25 new files.
- **2026-02-08**: Session 18 — Completed M10 remaining tasks: 10.1b (production backup script) and 10.2 (seed script). **Milestone 10 now DONE.** (10.1b) Created `deploy/postgres/backup.sh` — backs up both `pos_staging` and `pos_production` from shared `postgres` container, `set -euo pipefail`, non-empty verification, 30-day retention. Code quality review flagged offsite storage as future improvement (not a blocker). (10.2) Created `api/cmd/seed/main.go` — idempotent outlet + owner user creation, CLI flags with env var fallback, bcrypt password hashing. Code quality review caught 3 fixable issues: no transaction wrapper (orphaned outlet risk) → wrapped in `pgx.Tx`, no `pgx.ErrNoRows` distinction (DB errors silently treated as not-found) → added explicit check, weak default password with no warning → added log warning. Updated Makefile `db-seed` target. Commits: `19a5484`, `bbc02c3`. All milestones through M10 complete. Only M9 (SvelteKit Admin) remains.
- **2026-02-07**: Milestone 3 tasks 3.1–3.4 completed. Each task went through subagent-driven-development: implement → spec review → code quality review → fix → commit. Task 3.5 (Combo Items) pending.
- **2026-02-07**: Session 2 — Completed 3.5 (Combo Items) and 4.1 (Order Creation). Milestone 3 now DONE. Milestone 4 started. Task 4.1 introduced first service layer (`service/order.go`) with transaction handling, price snapshots, discount math, and retry-on-conflict for order numbers. Two review cycles caught: missing service tests (added 28), race condition fix, string-matching error classification replaced with sentinel errors.
- **2026-02-07**: Session 3 — Completed 4.2 (Order Queries & Status) and 4.3 (Order Item Modifications). Each went through full subagent-driven-development cycle. Key review findings fixed: (4.2) TOCTOU race on status transitions → added WHERE status=$current to SQL, completed_at never set → CASE WHEN COMPLETED, inconsistent cancel rules → synced PATCH/DELETE. (4.3) Runtime blocker: updated_at column missing from order_items → removed from SQL, no transaction on AddItem → added TxBeginner to handler, kitchen status on cancelled orders → added status check. 336 tests passing.
- **2026-02-07**: Session 4 — Completed 4.4 (Multi-Payment) and 5.1 (Customer CRUD + Stats). Milestone 4 now DONE. Milestone 5 started. Key review findings fixed: (4.4) Spec review caught TOCTOU race on payment validation → moved GetOrder+SumPayments inside tx with SELECT FOR NO KEY UPDATE row lock. Code quality approved. (5.1) Both reviewers caught missing GET single customer endpoint → added. Code quality reviewer caught stats queries not scoped by outlet_id → added AND o.outlet_id=$2. Also flagged LIKE wildcard injection and soft-delete vs unique constraint — deferred as schema-level concerns. 380 tests passing.
- **2026-02-07**: Session 5 — Merged `feature/milestone-2-auth` worktree into `main` (fast-forward, 15 commits). Worktree and branch cleaned up. Post-merge review of Task 4.4 (Multi-Payment): code quality reviewer caught that COMPLETED orders weren't explicitly blocked from accepting payments (only indirectly via sum check). Fix: added explicit COMPLETED guard + test, also fixed `TestAddPayment_AlreadyFullyPaid` which was silently testing wrong code path after guard addition (changed order status from COMPLETED→NEW). 381 tests passing.
- **2026-02-07**: Session 6 — Completed 5.2 (Reports) and 5.3 (WebSocket). Milestone 5 now DONE. Used worktree `feature/milestone-5-crm-reports-ws`, merged to main (fast-forward, 2 commits). Key review findings fixed: (5.2) Timezone mismatch — `time.Parse` produces UTC but orders are Asia/Jakarta, early morning orders missed → fixed with `time.ParseInLocation("2006-01-02", s, jakartaLoc)`. Untyped sqlc params from `$3 + interval '1 day'` → moved end-of-day to Go. Test package `handler` → `handler_test`. Added date range validation. (5.3) Misleading mutex in broadcast → changed to single write lock covering entire broadcast body. 401 tests passing.
- **2026-02-07**: Session 7 — Completed 6.1 (Router Assembly) and 6.2 (Integration Tests). Milestone 6 now DONE. Used worktree `feature/milestone-6-router-integration`, merged to main (fast-forward, 2 commits). Key review findings: (6.1) Spec reviewer confirmed all 11 handler groups wired correctly with proper middleware ordering. Code quality caught WriteTimeout:15s killing WebSocket connections → fixed to WriteTimeout:0 (WS pumps manage own deadlines). (6.2) Spec reviewer caught single-payment-as-multi and missing price assertion → fixed: split CASH+QRIS with partial payment verification, explicit total_amount==57000.00 assertion. Code quality approved with documentation additions (hub leak note, migration path comment, raw SQL justification). 401 unit tests + 1 integration test.
- **2026-02-07**: Session 10 — First device test. Set up CLI Android build toolchain (Homebrew: openjdk@17, android-commandlinetools, gradle). Build fixes: JAVA_HOME typo in .zshrc (two exports on one line), compileSdk 34→35 (androidx.core 1.15.0 requires SDK 35), README.md files in res/ dirs rejected by resource merger → deleted, API base URL had wrong `/api/v1/` prefix (Go API uses bare paths like `/auth/login`), HTTP blocked by Android cleartext policy → added usesCleartextTraffic=true. Seeded test outlet + user (bcrypt hash via go run). Login tested successfully on real Android device over local WiFi (Mac IP 192.168.1.7:8082). Dev workflow: `./gradlew installDebug` via USB.
- **2026-02-07**: Session 9 — Completed 8.1 (Scaffold Android Project) and 8.2 (Login Screen). Milestone 8 started. Used worktree `feature/milestone-8-android-pos`. (8.1) Full Android project: Gradle version catalogs, Kotlin 2.1.0, Compose BOM 2024.12, KSP+Hilt 2.54, Retrofit+OkHttp NetworkModule, Kiwari brand theme (7 colors, light/dark, M3 typography). Spec review caught missing gradlew + 0-byte font placeholders → fixed (gradlew added, fonts switched to system default). Code quality caught: config cache+Hilt conflict → disabled, debug localhost→10.0.2.2, missing shrinkResources → added, lenient Gson → strict. (8.2) Full auth vertical slice: AuthApi (login/pin-login/refresh), LoginScreen (dual email+PIN modes), TokenRepository (EncryptedSharedPreferences AES256), AuthInterceptor (Bearer header), TokenAuthenticator (auto-refresh on 401 via dual OkHttpClient pattern), NavGraph with auth-state routing. Spec review caught: plain-text DataStore (not encrypted) + missing auto-refresh → both fixed. Code quality caught: AuthRepository using wrong @Named AuthApi → fixed, missing logout→login navigation → added LaunchedEffect, dead isRefreshing field → removed, innerPadding unused → passed through, UserRole enum crash on unknown → UNKNOWN fallback, error snackbar re-fires → clearError(), DRY violation → extracted safeApiCall helper, security-crypto alpha→stable 1.0.0, credentials not cleared after login → cleared. 56 files, 2488 lines added.
- **2026-02-07**: Session 11 — Completed 8.3 (Menu Screen) and 8.4 (Product Customization). Each went through full subagent-driven-development cycle (implement → spec review → fix → code quality review → fix → amend commit). Key findings: (8.3) Spec review caught nullable API field mismatches (preparationTime, maxSelect) and missing NavGraph composable registrations → runtime crash prevention. Code quality caught trailing slashes in MenuApi (potential 404), N+1 sequential variant group fetches → parallelized with async/awaitAll, non-reactive dead properties → removed, duplicated safeApiCall → extracted to ApiHelper.kt, duplicated formatPrice → extracted to CurrencyFormatter.kt with cached NumberFormat. (8.4) Spec review caught critical multi-variant-group bug: CartItem.selectedVariant was singular SelectedVariant?, silently dropping all but first variant group selection → refactored to selectedVariants: List<SelectedVariant> across CartItem, CartRepository, and CustomizationViewModel. Code quality caught broken retry() path (product cleared from SelectedProductRepository before retry), silent empty groups on sub-fetch failure → filtered out, fragile one-shot addedToCart event → reset after handling. 18 new files, 7 modified, ~3400 lines. Worktree 4 commits ahead of main.
- **2026-02-07**: Session 12 — Bold + Clean theme redesign (Task 8.4b). Executed 6-task implementation plan via subagent-driven-development. 3 commits: (1) `9a44467` theme tokens — replaced KiwariColors.kt (9 new colors, removed 10 old: DarkGrey, CreamLight, AccentRed, BorderYellow, SurfaceGrey, Black, LightGrey, MediumGrey, DarkBackground, DarkSurface), KiwariTheme.kt (removed dark theme + dynamic color, added Shapes 8-16dp), KiwariTypography.kt (tightened 57sp→20sp max, all sizes 11-20sp). (2) `5ef9dee` hardcoded colors — CustomizationScreen.kt and ProductListItem.kt replaced PrimaryGreen/PrimaryYellow/White imports with MaterialTheme.colorScheme tokens. Code quality review caught misplaced import + hardcoded RoundedCornerShape(8dp) → fixed to MaterialTheme.shapes.extraSmall. (3) `4583e31` dimensions — CartBottomBar elevation 8→4dp, CategoryChips selected green→yellow + shape=extraSmall, ProductListItem divider indent 72→84dp (matches 56dp avatar). Clean build verified, APK assembled. Worktree 7 commits ahead of main.
- **2026-02-08**: Session 13 — Completed 8.5 (Cart Screen). Full subagent-driven-development cycle: implementation (from previous session) → build fix (Icons.Default.Remove not in core set → replaced with text "−") → spec review → code quality review → fixes → commit. Spec review caught: missing Edit button on cart items (spec said "Edit / delete buttons"), missing numeric keyboard types on discount/table number inputs → added edit notes dialog, KeyboardType.Number/Decimal/Phone. Code quality caught: 3 unused imports (BorderStroke, background, clickable) → removed, fully qualified DropdownMenu/DropdownMenuItem → proper imports, fully qualified java.math.BigDecimal → imported, customer phone field missing KeyboardType.Phone → added. Unrelated Makefile+api/seed/ changes excluded from commit. 6 new files, 2 modified, 1469 lines. Worktree 8 commits ahead of main.
- **2026-02-08**: Session 14 — Completed 8.6 (Payment Screen) and 8.7 (Catering Booking Screen). Each went through full subagent-driven-development cycle (implement → spec review → fix → code quality review → fix → amend commit). Key findings: (8.6) Spec review caught critical BigDecimal `==` bug in canSubmit — `BigDecimal("0.00") == BigDecimal.ZERO` is false due to scale mismatch → fixed with `compareTo()`. Also caught multi-payment overpayment risk (partial submission failure) → added client-side validation. Created OrderMetadataRepository singleton to bridge order metadata between Cart and Payment screens (avoids serializing complex objects through nav args). Code quality caught: dead capping code after validation added, duplicated `coerceAtLeast` → extracted to shared util, no `@Volatile` on singleton var → added, no BackHandler during submission → added. (8.7) Spec review caught missing notes field per wireframe → added. Code quality caught: duplicated `parseBigDecimal`/`filterDecimalInput` across 2 VMs → extracted to BigDecimalExtensions.kt, orphaned order on DP payment failure (retry creates duplicate) → added `createdOrderId` state for payment-only retry, date picker clickable during submission → disabled. 8 new files, 7 modified total across both tasks. Worktree 10 commits ahead of main.
- **2026-02-08**: Session 15 — Completed 8.8 (Thermal Printer Integration). **Milestone 8 now DONE.** Full subagent-driven-development cycle. Spec review caught: CateringViewModel `triggerAutoprint()` used stale `state.orderNumber` (always "CATERING") instead of API response → passed `orderNumber` explicitly. Also removed unused `BLUETOOTH_SCAN` permission. Code quality review caught 5 issues: (I-1) DataStore write per keystroke on outlet name → debounced with 500ms Job cancellation, (I-2) `isConnected()` via unreliable `socket?.isConnected` → use StateFlow, (I-3) legacy BT permissions without `maxSdkVersion="30"` → added, (I-4) O(n²) `fold` for byte arrays → extracted `merge()` as shared utility, (I-5) catering retry path loses order number → stored in state on first creation. Minor: removed unused `Icons.Default.Close` import. Branch `feature/milestone-8-android-pos` (11 commits) merged to main at `d83df97`. Worktree cleaned up. Total Milestone 8: 100 files, 10,384 lines added, 8 tasks + 1 theme redesign.
- **2026-02-08**: Session 17 — End-to-end CI/CD pipeline test. **CI/CD now DONE.** Commented out admin containers in VPS staging+production compose files (admin image doesn't exist yet). Added `version` field to /health endpoint as trigger change. Pushed to main → API CI ran: test✅ → build-and-push✅ → deploy-staging failed on health check (404 from openresty). Debugged: API container was running and healthy internally, but NPM proxy hosts for POS domains had no nginx `.conf` files despite showing "Online" in UI. Root cause: NPM WebSocket toggle causes duplicate `proxy_http_version` directive → nginx config test fails → NPM deletes the `.conf` but keeps the DB entry. Fix: disabled WebSocket toggle in NPM UI, added WebSocket headers via Advanced custom nginx config (`location /ws/` block). After fix, staging health check passed. Tagged `v1.0.0` → promote.yml re-tagged `:staging`→`:latest` → production deployed successfully. Both `stg-api.nasibakarkiwari.com/health` and `api.nasibakarkiwari.com/health` returning `{"status":"ok","version":"1.0.0"}`. Commit: `4bc08b3`.
- **2026-02-08**: Session 16 — CI/CD setup. Brainstormed CI/CD design: TBD (trunk-based), GitHub Actions with path-filtered workflows per service, ghcr.io container registry, SSH deploy to VPS. Decisions: staging+prod on same VPS, unified monorepo versioning, manual migrations, basic health check (no auto-rollback), promote staging→prod by re-tagging image (no rebuild), single shared PostgreSQL with separate DBs per env. Implemented 6 code tasks (CORS, 3 workflows, deploy compose files, gitignore). Code review caught: secret exposure via ${{ secrets }} in SSH scripts → fixed with envs param, shared .env PORT conflict (SvelteKit inherits PORT=8081) → split into api .env + admin.env, missing concurrency groups → added, workflow self-trigger gap → added. VPS setup: generated deploy SSH key, added to VPS + GitHub secrets, created GHCR classic PAT (fine-grained doesn't support packages), set 4 repo secrets, created staging+production environments, copied deploy files to VPS, created .env files with generated passwords, started shared PostgreSQL (init script created both DBs + users), ran migrations on both DBs, docker login to ghcr.io. Cloudflare DNS records added. NPM proxy hosts added for API only (admin deferred to M9). Evaluated Cloudflare Pages for admin — rejected due to WebSocket requirement (hard blocker), SSR design, and image uploads. Remaining: end-to-end pipeline test (comment out admin in VPS compose first, then push API change to trigger staging deploy). Commits: `5672a0e`→`4f6d8ff` (8 commits on main).
- **2026-02-07**: Session 8 — Completed 7.1 (Production Docker Compose) and 7.2 (Backup Script). Milestone 7 now DONE. Used worktree `feature/milestone-7-docker`, merged to main (fast-forward, 2 commits). Key review findings: (7.1) Spec reviewer caught missing `internal: true` on pos-internal network → fixed. Code quality caught: Go version mismatch (golang:1.22 vs go.mod 1.25.7) → updated to golang:1.25-alpine, missing .dockerignore → added, no non-root user → added `app` user in both Dockerfiles, host port exposure → prefixed with 127.0.0.1 (NPM handles public traffic via proxy network), Alpine 3.19 EOL → updated to 3.21. (7.2) Code quality caught silent pg_dump failure in pipe (set -e doesn't catch left side of pipe) → added set -o pipefail, file check -f → -s (non-empty), cron example missing log redirect → added. Backend complete through M7. Next: Android POS (M8, priority).
